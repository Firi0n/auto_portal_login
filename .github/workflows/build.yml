name: Build and Release

on:
  # Trigger on tag push (e.g., v1.0.0)
  push:
    tags:
      - "v*.*.*"

  # Allow manual trigger with a required input
  workflow_dispatch:
    inputs:
      tag_name:
        description: "Tag version (e.g., v1.2.3)"
        required: true

jobs:
  build:
    name: Build on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest] # Define OS matrix for cross-platform builds

    steps:
      # Checkout the source code from the repository
      - name: 🧾 Checkout repository
        uses: actions/checkout@v4

      # Set up the desired Python version
      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # Run the custom Python build script (creates venv, installs deps, builds app)
      - name: 🧱 Build project
        run: python build.py

      # Determine the tag name used for release:
      # - If triggered manually, use input
      # - If triggered by tag push, extract it from GITHUB_REF
      - name: 🆔 Determine tag name
        id: tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "TAG_NAME=${{ github.event.inputs.tag_name }}" >> "$GITHUB_ENV"
          else
            echo "TAG_NAME=${GITHUB_REF##*/}" >> "$GITHUB_ENV"
          fi

      # Create a GitHub release and upload the built file(s) from /dist
      - name: 🚀 Create GitHub Release
        if: env.TAG_NAME != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG_NAME }}
          files: dist/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
